@let filteredItems =
  treeItems() || leafItems() | search: searchText() : ['items.label', 'items.description'];
<p-popover
  styleClass="max-h-[50vh] overflow-y-auto transition-all duration-300"
  [dismissable]="true"
  #menuElement
>
  <div class="flex flex-col" [style.minWidth.px]="width()">
    @if (search()) {
      <header class="p-4 sticky top-0 bg-white">
        <ui-search-input [(search)]="searchText" (searchChange)="align()"></ui-search-input>
      </header>
    }
    @if (filteredItems.length) {
      @if (tree()) {
        @for (category of filteredItems; track category.id) {
          <div class="flex flex-col gap-2">
            <div class="border-b border-gray-300 px-4 py-2">
              <ui-title [heading]="HeadingType.H4">{{ category.label }}</ui-title>
            </div>
            <ng-container
              *ngTemplateOutlet="menu; context: { $implicit: category.items }"
            ></ng-container>
          </div>
        }
      } @else {
        <ng-container
          *ngTemplateOutlet="menu; context: { $implicit: filteredItems }"
        ></ng-container>
      }
    } @else {
      <p class="p-4 flex items-center justify-center gap-2">
        <ui-icon name="lucidePackageOpen" class="text-indigo-500 text-xl"></ui-icon>
        <ui-title [heading]="HeadingType.H4">No items found</ui-title>
      </p>
    }
  </div>
</p-popover>
<ng-template let-items [appGenericContextGuard]="leafItems()" #menu>
  <ul class="flex flex-col">
    @for (item of items; track item.id) {
      <li>
        <button
          class="flex items-center gap-4 w-full text-left hover:bg-indigo-50 focus:bg-indigo-100 hover:cursor-pointer px-4 py-2 outline-none"
          [attr.aria-label]="item.label"
          role="menuitem"
          tabindex="0"
          (click)="handle(item)"
          (keydown.enter)="handle(item)"
        >
          <ui-icon class="text-indigo-500" [name]="item.icon" aria-hidden="true"></ui-icon>

          <div class="flex flex-col">
            <p class="text-sm font-semibold">{{ item.label }}</p>
            @if (item.description) {
              <small class="text-xs text-gray-500">{{ item.description }}</small>
            }
          </div>
        </button>
      </li>
    }
  </ul>
</ng-template>
